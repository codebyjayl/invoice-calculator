<!DOCTYPE html>
<html lang="en">
<!-- v7.1 - Reduced top spacing -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice & Quotation Calculator</title>
    <style>
        /* ===== DESIGN SYSTEM FOUNDATION ===== */
        
        /* Import Inter font family */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            /* === COLOR PALETTE === */
            /* Primary Colors */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;

            /* Neutral Colors */
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;

            /* Semantic Colors */
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;
            
            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-500: #ef4444;
            --error-600: #dc2626;
            --error-700: #b91c1c;
            
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --warning-700: #b45309;

            /* === TYPOGRAPHY SYSTEM === */
            /* Font Families */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;

            /* Font Sizes */
            --text-xs: 0.75rem;      /* 12px */
            --text-sm: 0.875rem;     /* 14px */
            --text-base: 1rem;       /* 16px */
            --text-lg: 1.125rem;     /* 18px */
            --text-xl: 1.25rem;      /* 20px */
            --text-2xl: 1.5rem;      /* 24px */
            --text-3xl: 1.875rem;    /* 30px */
            --text-4xl: 2.25rem;     /* 36px */
            --text-5xl: 3rem;        /* 48px */

            /* Font Weights */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* Line Heights */
            --leading-tight: 1.25;
            --leading-snug: 1.375;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;
            --leading-loose: 2;

            /* === SPACING SYSTEM === */
            /* Spacing Scale (based on 4px grid) */
            --space-0: 0;
            --space-1: 0.25rem;      /* 4px */
            --space-2: 0.5rem;       /* 8px */
            --space-3: 0.75rem;      /* 12px */
            --space-4: 1rem;         /* 16px */
            --space-5: 1.25rem;      /* 20px */
            --space-6: 1.5rem;       /* 24px */
            --space-7: 1.75rem;      /* 28px */
            --space-8: 2rem;         /* 32px */
            --space-10: 2.5rem;      /* 40px */
            --space-12: 3rem;        /* 48px */
            --space-14: 3.5rem;      /* 56px */
            --space-16: 4rem;        /* 64px */
            --space-20: 5rem;        /* 80px */
            --space-24: 6rem;        /* 96px */

            /* === BORDER RADIUS === */
            --radius-none: 0;
            --radius-sm: 0.125rem;   /* 2px */
            --radius-base: 0.25rem;  /* 4px */
            --radius-md: 0.375rem;   /* 6px */
            --radius-lg: 0.5rem;     /* 8px */
            --radius-xl: 0.75rem;    /* 12px */
            --radius-2xl: 1rem;      /* 16px */
            --radius-full: 9999px;

            /* === SHADOWS === */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* === TRANSITIONS === */
            --transition-fast: 150ms ease-in-out;
            --transition-base: 200ms ease-in-out;
            --transition-slow: 300ms ease-in-out;





        }

        /* === BASE STYLES === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            font-size: var(--text-base);
            line-height: var(--leading-normal);
            color: var(--neutral-800);
            background-color: var(--neutral-50);
            padding: 0;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* === UTILITY CLASSES === */
        /* Removed unused utility classes to reduce file size */

        /* === INTERACTIVE STATES === */
        
        /* Focus Ring for Accessibility */
        *:focus {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }

        /* Remove default focus for mouse users */
        *:focus:not(:focus-visible) {
            outline: none;
        }

        /* Enhanced focus for keyboard users */
        *:focus-visible {
            outline: 3px solid var(--primary-500);
            outline-offset: 2px;
            box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.2);
        }





        /* === SUBTLE ANIMATIONS === */
        
        /* Micro Interactions */
        .btn:active {
            transform: translateY(1px) scale(0.98);
        }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* === MAIN LAYOUT === */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 420px;
            height: 100vh;
            gap: 0;
            background: linear-gradient(135deg, var(--neutral-100), var(--neutral-50));
            position: relative;
        }

        .main-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-500), var(--primary-400));
            z-index: 10;
        }

        .invoice-container {
            background: white;
            border-right: 3px solid var(--neutral-200);
            overflow-y: auto;
            padding: var(--space-6) var(--space-10) var(--space-10) var(--space-10);
            box-shadow: var(--shadow-xl);
            position: relative;
            margin: var(--space-4) 0 var(--space-4) var(--space-4);
            border-radius: var(--radius-xl);
            border: 1px solid var(--neutral-200);
        }

        .controls-container {
            background: linear-gradient(135deg, var(--neutral-100), var(--neutral-50));
            overflow-y: auto;
            padding: var(--space-6);
            border-left: 1px solid var(--neutral-200);
            position: relative;
            border-radius: var(--radius-xl);
            margin: var(--space-4) var(--space-4) var(--space-4) 0;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--neutral-200);
        }

        .controls-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--success-600), var(--success-400));
            border-radius: var(--radius-full);
        }

        /* === INVOICE HEADER === */
        .invoice-header {
            display: grid;
            grid-template-columns: auto 1fr;
            margin-bottom: var(--space-4);
            padding: 0 0 var(--space-3) 0;
            border-bottom: 2px solid var(--neutral-200);
            gap: var(--space-8);
            align-items: center;
        }

        .logo-title-section {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            align-self: center;
        }

        .right-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            align-self: center;
        }

        .document-title {
            font-size: var(--text-5xl);
            font-weight: var(--font-bold);
            color: var(--primary-600);
            line-height: 1;
            letter-spacing: -0.02em;
            margin: 0 0 var(--space-2) 0;
            padding: 0;
            text-align: right;
            text-transform: uppercase;
        }

        .logo-placeholder {
            /* Dynamic size controlled by JavaScript - default 80px for compact design */
            width: 80px;
            height: 80px;
            max-width: 200px;
            max-height: 130px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease;
            background: transparent;
        }

        /* Show dashed border only when no logo is uploaded */
        .logo-placeholder.empty {
            border: 2px dashed var(--neutral-300);
            background: var(--neutral-50);
            border-radius: var(--radius-md);
        }

        .logo-placeholder.empty:hover {
            border-color: var(--primary-400);
            background: var(--primary-50);
            transform: translateY(-1px);
        }

        .logo-placeholder img {
            display: none;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            background: transparent;
            /* Remove any background from the image itself */
            mix-blend-mode: multiply;
            /* Brighten and increase contrast to hide gray background */
            filter: brightness(1.05) contrast(1.1);
        }
        
        .logo-placeholder img.active {
            display: block;
        }

        .logo-placeholder .logo-text {
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            color: var(--neutral-500);
            text-align: center;
            letter-spacing: 0.025em;
        }

        .company-info {
            text-align: right;
            font-size: var(--text-sm);
        }

        .company-name {
            font-size: var(--text-lg);
            font-weight: var(--font-bold);
            color: var(--neutral-800);
            margin-bottom: var(--space-2);
            line-height: 1.2;
            letter-spacing: -0.01em;
        }

        .company-details {
            line-height: 1.5;
            color: var(--neutral-600);
            font-size: var(--text-sm);
            font-weight: var(--font-normal);
        }

        .company-details div {
            margin-bottom: 3px;
        }

        .company-details span {
            color: var(--neutral-800);
            font-weight: var(--font-semibold);
        }

        /* === INVOICE DETAILS SECTION === */
        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-10);
            margin-bottom: var(--space-8);
            padding: var(--space-6);
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--radius-xl);
            border: 2px solid var(--neutral-200);
            box-shadow: var(--shadow-sm);
        }

        .invoice-to-section h3,
        .job-section h3 {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
            margin-bottom: var(--space-3);
            letter-spacing: -0.01em;
        }

        .customer-info,
        .job-description {
            background: transparent;
            border: 2px solid transparent;
            width: 100%;
            resize: none;
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            line-height: var(--leading-relaxed);
            color: var(--neutral-700);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            transition: var(--transition-base);
        }

        .customer-info {
            min-height: 80px;
        }

        .job-description {
            min-height: 60px;
        }

        .customer-info:focus,
        .job-description:focus {
            outline: none;
            border-color: var(--primary-500);
            background: var(--primary-50);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .customer-info:hover,
        .job-description:hover {
            border-color: var(--neutral-300);
            background: var(--neutral-50);
        }

        .job-section {
            margin-top: var(--space-6);
        }

        .document-meta {
            text-align: right;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            align-items: center;
            gap: var(--space-3);
        }

        .meta-row label {
            font-weight: var(--font-semibold);
            color: var(--neutral-800);
            min-width: 90px;
            font-size: var(--text-sm);
        }

        .meta-row span {
            color: var(--neutral-600);
            font-weight: var(--font-normal);
            font-size: var(--text-sm);
        }

        .meta-row input {
            border: 2px solid transparent;
            background: transparent;
            text-align: right;
            font-weight: var(--font-medium);
            padding: var(--space-2);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            color: var(--neutral-700);
            transition: var(--transition-base);
        }

        .meta-row input:focus {
            outline: none;
            border-color: var(--primary-500);
            background: rgba(59, 130, 246, 0.02);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .meta-row input:hover {
            border-color: var(--neutral-300);
            background: var(--neutral-50);
        }

        /* === LINE ITEMS TABLE === */
        .line-items-section {
            margin-bottom: var(--space-8);
            padding-top: var(--space-6);
            margin-top: var(--space-6);
            position: relative;
            overflow-x: auto; /* Allow horizontal scroll on mobile */
        }

        .line-items-section::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 0;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-400));
            border-radius: var(--radius-full);
        }

        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: var(--text-sm);
            border: 1px solid var(--neutral-200);
            border-radius: 0;
            background: white;
        }

        .line-items-table th {
            background: var(--primary-600);
            padding: var(--space-4) var(--space-2);
            text-align: center;
            font-weight: var(--font-bold);
            color: white;
            border: 1px solid var(--primary-700);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            line-height: 1.2;
            min-height: 58px;
            vertical-align: middle;
        }

        .line-items-table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-600);
        }

        .line-items-table th:nth-child(1) {
            width: 8%;
            text-align: center;
        }

        .line-items-table th:nth-child(2) {
            width: 40%;
            text-align: left;
        }

        .line-items-table th:nth-child(3) {
            width: 12%;
            text-align: center;
        }

        .line-items-table th:nth-child(4) {
            width: 15%;
            text-align: center;
        }

        .line-items-table th:nth-child(5) {
            width: 15%;
            text-align: center;
        }

        .line-items-table th:nth-child(6) {
            width: 10%;
            text-align: center;
        }

        .line-items-table td {
            padding: var(--space-2) var(--space-2);
            border: 1px solid var(--neutral-200);
            background: white;
            vertical-align: middle;
            font-size: var(--text-sm);
            color: var(--neutral-700);
            transition: var(--transition-fast);
            min-height: 48px;
            line-height: 1.1;
        }

        .line-items-table tbody tr td {
            background: white;
        }

        .line-items-table tbody tr:hover td {
            background: var(--neutral-50);
        }

        .line-items-table td:nth-child(1) {
            width: 8%;
            text-align: center;
        }

        .line-items-table td:nth-child(2) {
            width: 40%;
            text-align: left;
        }

        .line-items-table td:nth-child(3) {
            width: 12%;
            text-align: center;
        }

        .line-items-table td:nth-child(4),
        .line-items-table td:nth-child(5) {
            width: 15%;
            text-align: center;
            font-weight: var(--font-medium);
            font-family: var(--font-primary);
        }

        .line-items-table td:nth-child(6) {
            width: 10%;
            text-align: center;
        }

        .line-items-table input {
            width: 100%;
            border: none;
            background: transparent;
            text-align: inherit;
            font-size: var(--text-sm);
            padding: var(--space-1);
            font-family: var(--font-primary);
            color: var(--neutral-700);
            font-weight: var(--font-medium);
            transition: var(--transition-fast);
            min-height: 32px;
            box-sizing: border-box;
        }

        .line-items-table input:focus {
            outline: 2px solid var(--primary-500);
            background: var(--primary-50);
            border-radius: var(--radius-sm);
        }

        /* Rate column display/input styling */
        .line-items-table .rate-display {
            display: inline-block;
            cursor: pointer;
            padding: var(--space-2);
            min-width: 100%;
            text-align: center;
        }

        .line-items-table .rate-input {
            display: none;
        }

        .line-items-table td:nth-child(4):hover .rate-display {
            background: var(--neutral-100);
            border-radius: var(--radius-sm);
        }

        .line-items-table td:nth-child(4).editing .rate-display {
            display: none;
        }

        .line-items-table td:nth-child(4).editing .rate-input {
            display: inline-block;
        }

        .line-items-table .action-btn {
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-bold);
            margin: 0 auto;
        }

        .add-remove-buttons {
            padding: var(--space-4) 0;
            text-align: right;
        }

        /* === PAYMENT TERMS AND TOTALS === */
        .payment-totals-section {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: var(--space-8);
            margin-top: var(--space-10);
            padding-top: var(--space-8);
            border-top: 3px solid var(--neutral-200);
            position: relative;
        }

        .payment-totals-section::before {
            content: '';
            position: absolute;
            top: -3px;
            right: 0;
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
            border-radius: var(--radius-full);
        }

        .payment-terms {
            background: linear-gradient(135deg, var(--neutral-50), white);
            color: var(--neutral-700);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--neutral-200);
            position: relative;
            overflow: hidden;
        }

        .payment-terms::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        }

        .payment-terms h4 {
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            margin-bottom: var(--space-4);
            border-bottom: 2px solid var(--neutral-300);
            padding-bottom: var(--space-3);
            letter-spacing: -0.02em;
            color: var(--neutral-800);
        }

        .payment-terms-content {
            font-size: var(--text-sm);
            line-height: var(--leading-relaxed);
            text-align: justify;
            font-weight: var(--font-normal);
            color: var(--neutral-600);
        }

        .thank-you {
            text-align: center;
            margin-top: var(--space-8);
            font-style: italic;
            color: var(--neutral-600);
            font-size: var(--text-base);
            font-weight: var(--font-medium);
            padding: var(--space-4);
            background: linear-gradient(135deg, var(--neutral-50), white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--neutral-200);
            box-shadow: var(--shadow-sm);
        }

        .totals-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .totals-table {
            border-collapse: collapse;
            min-width: 300px;
            font-size: var(--text-sm);
            background: white;
            border: 1px solid var(--neutral-200);
        }

        .totals-table td {
            padding: var(--space-2) var(--space-2);
            border: 1px solid var(--neutral-200);
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        .totals-table .label {
            text-align: center;
            font-weight: var(--font-medium);
            color: var(--neutral-600);
            padding: var(--space-2) var(--space-2);
            min-width: 140px;
            font-size: var(--text-sm);
            text-transform: none;
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        .totals-table .amount {
            text-align: center;
            font-weight: var(--font-semibold);
            color: var(--neutral-700);
            min-width: 100px;
            font-family: var(--font-primary);
            font-size: var(--text-sm);
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        .totals-table .total-row .label {
            font-weight: var(--font-bold);
            color: white;
            border-top: 1px solid var(--primary-600);
            padding: var(--space-2) var(--space-2);
            background: var(--primary-600);
            font-size: var(--text-lg);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        .totals-table .total-row .amount {
            font-weight: var(--font-bold);
            color: white;
            font-size: var(--text-2xl);
            border-top: 1px solid var(--primary-600);
            padding: var(--space-2) var(--space-2);
            background: var(--primary-600);
            font-family: var(--font-primary);
            min-height: 48px;
            line-height: 1.1;
            vertical-align: middle;
        }

        /* === CONTROLS STYLING === */
        .control-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-md);
            border: 2px solid var(--neutral-200);
            transition: var(--transition-base);
        }

        .control-section:hover {
            border-color: var(--primary-300);
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }

        .control-section:focus-within {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), var(--shadow-lg);
        }

        .control-section h3 {
            margin-bottom: var(--space-4);
            color: var(--neutral-800);
            border-bottom: 3px solid var(--primary-600);
            padding-bottom: var(--space-2);
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            letter-spacing: -0.01em;
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-group label {
            display: block;
            font-weight: var(--font-medium);
            margin-bottom: var(--space-2);
            color: var(--neutral-700);
            font-size: var(--text-sm);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            color: var(--neutral-700);
            transition: var(--transition-base);
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(59, 130, 246, 0.02);
        }

        .form-group input:hover,
        .form-group textarea:hover,
        .form-group select:hover {
            border-color: var(--neutral-400);
        }

        /* Enhanced Input States */
        .form-group input:disabled,
        .form-group textarea:disabled,
        .form-group select:disabled {
            background-color: var(--neutral-100);
            color: var(--neutral-500);
            cursor: not-allowed;
            border-color: var(--neutral-300);
        }

        /* Range Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #e2e8f0;
            outline: none;
            transition: background 0.3s;
        }

        input[type="range"]:hover {
            background: #cbd5e1;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-600);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-700);
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-600);
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: var(--primary-700);
            transform: scale(1.1);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        }





        /* === BUTTON SYSTEM === */
        .btn {
            padding: var(--space-3) var(--space-4);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            margin: var(--space-1);
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            line-height: var(--leading-tight);
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .btn-primary:hover {
            background: var(--primary-700);
            border-color: var(--primary-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-600);
            color: white;
            border-color: var(--success-600);
        }

        .btn-success:hover {
            background: var(--success-700);
            border-color: var(--success-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: var(--error-600);
            color: white;
            border-color: var(--error-600);
        }

        .btn-danger:hover {
            background: var(--error-700);
            border-color: var(--error-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--neutral-600);
            color: white;
            border-color: var(--neutral-600);
            font-size: var(--text-xs);
            padding: var(--space-2) var(--space-3);
        }

        .btn-secondary:hover {
            background: var(--neutral-700);
            border-color: var(--neutral-700);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .toggle-buttons {
            display: flex;
            border: 2px solid var(--primary-600);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .toggle-btn {
            padding: var(--space-3) var(--space-5);
            background: white;
            border: none;
            cursor: pointer;
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            font-family: var(--font-primary);
            flex: 1;
            transition: var(--transition-base);
            color: var(--primary-600);
        }

        .toggle-btn.active {
            background: var(--primary-600);
            color: white;
        }

        .toggle-btn:hover:not(.active) {
            background: var(--primary-50);
            color: var(--primary-700);
        }



        /* === PROFESSIONAL PRINT STYLES === */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .controls-container {
                display: none !important;
            }

            .main-container {
                grid-template-columns: 1fr !important;
                background: white !important;
                height: auto !important;
            }

            .main-container::before {
                display: none !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 9pt !important;
                line-height: 1.2 !important;
                color: #000 !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            .invoice-container {
                border: none !important;
                padding: 0.2in 0.3in 0.3in 0.3in !important;
                box-shadow: none !important;
                margin: 0 !important;
                border-radius: 0 !important;
                background: white !important;
                max-width: 100% !important;
            }

            /* === COMPACT HEADER SECTION === */
            .invoice-header {
                display: grid !important;
                grid-template-columns: auto 1fr !important;
                gap: 0.2in !important;
                margin-bottom: 0.08in !important;
                padding: 0 0 0.06in 0 !important;
                border-bottom: 2px solid #2563eb !important;
                background: none !important;
                align-items: center !important;
            }

            .logo-title-section {
                display: flex !important;
                align-items: center !important;
                justify-content: flex-start !important;
                align-self: center !important;
            }

            .right-section {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.06in !important;
                align-self: center !important;
            }

            /* Hide empty logo placeholder in print */
            .logo-placeholder.empty {
                display: none !important;
            }

            /* Show logo in print if it has content - size scales with screen version */
            .logo-placeholder:not(.empty) {
                display: flex !important;
                /* Width and height will be inherited from inline styles set by JavaScript */
                /* Convert pixels to inches for print: divide by 96 (screen DPI) */
                border: none !important;
                background: transparent !important;
                border-radius: 0 !important;
                box-shadow: none !important;
                max-width: 2in !important;
                max-height: 1.5in !important;
            }

            .logo-placeholder img.active {
                display: block !important;
                max-width: 100% !important;
                max-height: 100% !important;
                object-fit: contain !important;
                mix-blend-mode: multiply !important;
                filter: brightness(1.05) contrast(1.1) !important;
            }

            .add-remove-buttons {
                display: none !important;
            }



            .line-items-table th:last-child,
            .line-items-table td:last-child {
                display: none !important;
            }

            /* Hide no-print elements only in print mode */
            .no-print {
                display: none !important;
            }

            /* Fix font alignment and visibility issues */
            .payment-terms {
                background: white !important;
                color: #000 !important;
                border: 2px solid #000 !important;
                padding: 20px !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }

            .payment-terms h4 {
                color: #000 !important;
                font-weight: bold !important;
            }

            .payment-terms-content {
                color: #000 !important;
                font-size: 11px !important;
                line-height: 1.4 !important;
            }

            .company-info,
            .company-name,
            .company-details {
                color: #000 !important;
            }

            .document-title {
                color: #2563eb !important;
                font-size: 20pt !important;
                font-weight: bold !important;
                background: none !important;
                text-shadow: none !important;
                margin: 0 0 0.03in 0 !important;
                padding: 0 !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5pt !important;
                line-height: 1 !important;
                text-align: right !important;
            }

            .document-title::after {
                display: none !important;
            }

            .company-info {
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                text-align: right !important;
            }

            .company-name {
                font-size: 11pt !important;
                font-weight: bold !important;
                margin-bottom: 0.03in !important;
                color: #1e293b !important;
            }

            .company-details {
                font-size: 8pt !important;
                line-height: 1.3 !important;
                color: #000 !important;
            }

            .company-details div {
                margin-bottom: 0.02in !important;
            }

            /* === COMPACT INVOICE DETAILS === */
            .invoice-details {
                display: grid !important;
                grid-template-columns: 1.8fr 1fr !important;
                gap: 0.2in !important;
                margin-bottom: 0.1in !important;
                margin-top: 0.1in !important;
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
            }

            .invoice-to-section h3,
            .job-section h3 {
                color: #000 !important;
                font-size: 10pt !important;
                font-weight: bold !important;
                margin-bottom: 0.03in !important;
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
            }

            .meta-row label {
                font-weight: bold !important;
                color: #000 !important;
                font-size: 10pt !important;
                text-align: left !important;
                white-space: nowrap !important;
            }

            .customer-info,
            .job-description {
                color: #000 !important;
                border: none !important;
                padding: 0.02in 0 !important;
                background: white !important;
                font-size: 8pt !important;
                line-height: 1.1 !important;
                min-height: 0.25in !important;
                resize: none !important;
            }

            .job-section {
                margin-top: 0.08in !important;
            }

            .document-meta {
                text-align: right !important;
                width: 100% !important;
                display: block !important;
            }

            .meta-row {
                display: grid !important;
                grid-template-columns: 0.8in 1fr !important;
                gap: 0.1in !important;
                margin-bottom: 0.08in !important;
                align-items: center !important;
                width: 100% !important;
                line-height: 1.2 !important;
            }

            .meta-row:last-child {
                margin-bottom: 0 !important;
            }

            .meta-row label {
                font-weight: bold !important;
                color: #000 !important;
                font-size: 8pt !important;
                text-align: left !important;
                white-space: nowrap !important;
            }

            .meta-row span,
            .meta-row input {
                color: #000 !important;
                font-size: 8pt !important;
                border: none !important;
                background: none !important;
                text-align: right !important;
                width: 100% !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                line-height: 1.2 !important;
            }

            /* Completely hide date picker icon and fix date alignment */
            .meta-row input[type="date"] {
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                background: none !important;
                border: none !important;
                text-align: right !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                direction: ltr !important;
                unicode-bidi: normal !important;
            }

            .meta-row input[type="date"]::-webkit-calendar-picker-indicator {
                display: none !important;
                -webkit-appearance: none !important;
                opacity: 0 !important;
                width: 0 !important;
                height: 0 !important;
                position: absolute !important;
                right: -9999px !important;
            }

            .meta-row input[type="date"]::-webkit-inner-spin-button,
            .meta-row input[type="date"]::-webkit-outer-spin-button {
                display: none !important;
                -webkit-appearance: none !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit-fields-wrapper {
                padding: 0 !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit {
                padding: 0 !important;
                text-align: right !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit-text {
                padding: 0 !important;
            }

            .meta-row input[type="date"]::-webkit-datetime-edit-month-field,
            .meta-row input[type="date"]::-webkit-datetime-edit-day-field,
            .meta-row input[type="date"]::-webkit-datetime-edit-year-field {
                padding: 0 !important;
                text-align: right !important;
            }

            /* Ensure consistent alignment and formatting for all values */
            .meta-row span {
                display: block !important;
                text-align: right !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-size: 8pt !important;
                font-weight: normal !important;
                color: #000 !important;
                padding: 0 !important;
                margin: 0 !important;
                line-height: 1.2 !important;
            }

            .meta-row input:not([type="date"]) {
                display: block !important;
                text-align: right !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-size: 8pt !important;
                font-weight: normal !important;
                color: #000 !important;
                padding: 0 !important;
                margin: 0 !important;
                line-height: 1.2 !important;
            }

            .meta-row label,
            .meta-row span,
            .meta-row input {
                color: #000 !important;
            }

            .totals-table .label,
            .totals-table .amount {
                color: #000 !important;
            }

            .thank-you {
                color: #000 !important;
            }

            /* === COMPACT LINE ITEMS TABLE === */
            .line-items-section {
                border-top: 3px solid #e2e8f0 !important;
                padding-top: 0.06in !important;
                margin-top: 0.08in !important;
                margin-bottom: 0.08in !important;
                position: relative !important;
            }

            .line-items-section::before {
                display: none !important;
            }

            .line-items-table {
                width: 100% !important;
                border-collapse: collapse !important;
                border-spacing: 0 !important;
                border: 1px solid #e2e8f0 !important;
                border-radius: 0 !important;
                font-size: 7pt !important;
                margin-bottom: 0.08in !important;
                table-layout: fixed !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .line-items-table th {
                background: #2563eb !important;
                color: white !important;
                border: 1px solid #1d4ed8 !important;
                font-size: 7pt !important;
                font-weight: bold !important;
                padding: 0.04in 0.02in !important;
                text-align: center !important;
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
                height: 0.22in !important;
                min-height: 0.22in !important;
                max-height: 0.22in !important;
                line-height: 1.2 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                position: relative !important;
                overflow: hidden !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .line-items-table th:nth-child(1) { width: 6% !important; }
            .line-items-table th:nth-child(2) { 
                width: 59% !important; 
                text-align: left !important; 
            }
            .line-items-table th:nth-child(3) { width: 10% !important; }
            .line-items-table th:nth-child(4) { width: 10% !important; }
            .line-items-table th:nth-child(5) { width: 15% !important; }

            .line-items-table th::after {
                display: none !important;
                content: none !important;
                height: 0 !important;
                width: 0 !important;
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            }

            .line-items-table td {
                border: 1px solid #e2e8f0 !important;
                border-top: 1px solid #e2e8f0 !important;
                border-bottom: 1px solid #e2e8f0 !important;
                border-left: 1px solid #e2e8f0 !important;
                border-right: 1px solid #e2e8f0 !important;
                color: #000 !important;
                padding: 0.02in 0.02in !important;
                font-size: 7pt !important;
                background: white !important;
                text-align: center !important;
                vertical-align: middle !important;
                line-height: 1.1 !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                box-sizing: border-box !important;
                position: relative !important;
                overflow: hidden !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
                text-transform: none !important;
                letter-spacing: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .line-items-table td:nth-child(1) {
                text-align: center !important;
            }

            .line-items-table td:nth-child(2) {
                text-align: left !important;
            }

            .line-items-table td:nth-child(3) {
                text-align: center !important;
            }

            .line-items-table td:nth-child(4),
            .line-items-table td:nth-child(5) {
                text-align: center !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            /* Completely hide input styling in print - make them look like plain text */
            .line-items-table input {
                text-align: center !important;
                width: 100% !important;
                border: none !important;
                outline: none !important;
                background: transparent !important;
                font-size: 7pt !important;
                padding: 0 !important;
                margin: 0 !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
                vertical-align: middle !important;
                line-height: 1.1 !important;
                box-sizing: border-box !important;
                height: auto !important;
                min-height: 0 !important;
                max-height: none !important;
                display: inline !important;
                appearance: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                resize: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                text-shadow: none !important;
                -webkit-box-shadow: none !important;
                -moz-box-shadow: none !important;
            }

            .line-items-table td:nth-child(2) input {
                text-align: left !important;
            }

            .line-items-table td:nth-child(3) input {
                text-align: center !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                font-weight: normal !important;
            }

            .line-items-table td:nth-child(4) input,
            .line-items-table td:nth-child(5) input {
                text-align: center !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            /* Show formatted rate display in print, hide input */
            .line-items-table .rate-input {
                display: none !important;
            }
            
            .line-items-table .rate-display {
                display: inline-block !important;
            }

            .line-items-table tbody tr:hover td {
                background: white !important;
            }

            /* === COMPACT PAYMENT TERMS AND TOTALS === */
            .payment-totals-section {
                display: grid !important;
                grid-template-columns: 1.5fr 1fr !important;
                gap: 0.15in !important;
                margin-top: 0.08in !important;
                border-top: 2px solid #e2e8f0 !important;
                padding-top: 0.06in !important;
                position: relative !important;
            }

            .payment-totals-section::before {
                display: none !important;
            }

            .payment-terms {
                background: white !important;
                color: #000 !important;
                border: none !important;
                border-top: 1px solid #2563eb !important;
                padding: 0.04in 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }

            .payment-terms::before {
                display: none !important;
            }

            .payment-terms h4 {
                color: #2563eb !important;
                font-weight: bold !important;
                font-size: 8pt !important;
                margin-bottom: 0.03in !important;
                border-bottom: none !important;
                padding-bottom: 0.01in !important;
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
                text-shadow: none !important;
            }

            .payment-terms-content {
                color: #000 !important;
                font-size: 6pt !important;
                line-height: 1.1 !important;
                text-align: justify !important;
                text-shadow: none !important;
            }

            .totals-section {
                display: flex !important;
                flex-direction: column !important;
                align-items: flex-end !important;
            }

            .payment-totals-section .totals-section .totals-table {
                border-collapse: collapse !important;
                border: 1px solid #e2e8f0 !important;
                font-size: 7pt !important;
                width: 100% !important;
                min-width: auto !important;
                max-width: 1.5in !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .totals-table td {
                border: 1px solid #e2e8f0 !important;
                padding: 0.02in 0.02in !important;
                font-size: 7pt !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }



            /* Very light, subtle borders like reference image */
            .totals-table .label {
                text-align: center !important;
                font-weight: normal !important;
                color: #000 !important;
                font-size: 7pt !important;
                padding: 0.02in 0.02in !important;
                text-transform: none !important;
                border: 1px solid #e2e8f0 !important;
                border-right: 1px solid #cbd5e1 !important;
                background: white !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
            }

            .totals-table .amount {
                text-align: center !important;
                font-weight: normal !important;
                color: #000 !important;
                font-size: 7pt !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                border: 1px solid #e2e8f0 !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                border-left: 1px solid #cbd5e1 !important;
                background: white !important;
                box-sizing: border-box !important;
            }



            .totals-table .total-row .label,
            .totals-table .total-row .amount {
                border: 1px solid #1e40af !important;
                background: #2563eb !important;
                color: white !important;
                font-size: 7pt !important;
                font-weight: bold !important;
                padding: 0.02in 0.02in !important;
                height: 0.18in !important;
                min-height: 0.18in !important;
                max-height: 0.18in !important;
                line-height: 1.1 !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            }

            .totals-table .total-row .label {
                text-transform: uppercase !important;
                letter-spacing: 0.3pt !important;
                text-align: center !important;
            }

            .totals-table .total-row .amount {
                text-align: center !important;
            }

            /* === THANK YOU MESSAGE === */
            .thank-you {
                text-align: center !important;
                margin-top: 0.06in !important;
                font-style: italic !important;
                color: #666 !important;
                font-size: 7pt !important;
                background: none !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0.02in !important;
            }

            /* === PAGE SETTINGS === */
            @page {
                margin: 0.3in;
                size: A4 portrait;
            }

            /* Prevent page breaks inside important sections */
            .invoice-header,
            .invoice-details,
            .line-items-table,
            .payment-totals-section {
                page-break-inside: avoid !important;
            }

            /* Ensure proper spacing between sections */
            .invoice-header {
                page-break-after: avoid !important;
            }

            .line-items-section {
                page-break-before: avoid !important;
                page-break-after: avoid !important;
            }

            .payment-totals-section {
                page-break-before: avoid !important;
            }

            /* Hide all animations and transitions in print */
            * {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }

            /* Ensure all backgrounds and decorative elements are hidden */
            .line-items-section::before,
            .payment-totals-section::before,
            .document-title::after,
            .company-name::after {
                display: none !important;
            }
        }

        /* === RESPONSIVE GRID SYSTEM === */
        
        /* Large screens and up (1280px+) */
        @media (min-width: 1280px) {
            .main-container {
                grid-template-columns: 1fr 440px;
            }
            
            .invoice-container {
                padding: var(--space-12);
                margin: var(--space-6) 0 var(--space-6) var(--space-6);
            }
        }

        /* Medium screens and down (1024px-) */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 100vh;
                background: var(--neutral-50);
            }

            .invoice-container {
                border-right: none;
                border-bottom: 3px solid var(--neutral-200);
                padding: var(--space-6);
                margin: var(--space-4);
                border-radius: var(--radius-lg);
            }

            .controls-container {
                border-left: none;
                border-top: 3px solid var(--neutral-200);
                padding: var(--space-5);
                background: white;
                margin: 0 var(--space-4) var(--space-4) var(--space-4);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-md);
            }

            .controls-container::before {
                width: 100%;
                height: 3px;
                background: linear-gradient(90deg, var(--primary-600), var(--primary-400));
            }
        }

        /* Small screens (768px-) */
        @media (max-width: 768px) {
            .invoice-container {
                padding: var(--space-4);
            }
            
            .controls-container {
                padding: var(--space-4);
            }
        }

        /* Extra small screens (640px-) */
        @media (max-width: 640px) {
            .invoice-container {
                padding: var(--space-3);
            }
            
            .controls-container {
                padding: var(--space-3);
            }

            /* Mobile table improvements */
            .line-items-table {
                font-size: var(--text-xs);
                min-width: 100%;
            }

            .line-items-table th,
            .line-items-table td {
                padding: var(--space-1) var(--space-1);
                min-height: 44px; /* Touch-friendly minimum */
            }

            .line-items-table input {
                min-height: 36px;
                font-size: var(--text-sm);
            }

            /* Make buttons more touch-friendly */
            .btn {
                min-height: 44px;
                padding: var(--space-3) var(--space-4);
            }

            /* Improve form inputs for mobile */
            .form-group input,
            .form-group textarea,
            .form-group select {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Hide print button on very small screens */
            @media (max-width: 480px) {
                .btn:contains("Print") {
                    display: none;
                }
            }
        }

        /* Hide rows dynamically when not needed */
        .totals-table tr.hidden-row {
            display: none;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Left Side: Invoice Preview -->
        <div class="invoice-container">
            <!-- Invoice Header -->
            <div class="invoice-header">
                <div class="logo-title-section">
                    <div class="logo-placeholder empty">
                        <img id="logoImage">
                        <div class="logo-text" id="logoText">Logo</div>
                    </div>
                </div>
                <div class="right-section">
                    <div class="document-title" id="documentTitle">Invoice</div>
                    <div class="company-info">
                        <div class="company-name" id="displayCompanyName">IRONMARK LIMITED</div>
                        <div class="company-details">
                            <div>GST: <span id="displayGstNumber">124-884-594</span></div>
                            <div>E-mail: <span id="displayCompanyEmail">ironmarkinvoice@gmail.com</span></div>
                            <div>Bank Account Details: <span id="displayBankDetails">(ANZ) 01-0190-0529502-00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Details -->
            <div class="invoice-details">
                <div class="invoice-to-section">
                    <h3 id="invoiceToLabel">INVOICE TO:</h3>
                    <textarea class="customer-info" id="customerInfo"
                        placeholder="Enter customer details..."></textarea>

                    <div class="job-section">
                        <h3 id="jobLabel">PAINTING JOB:</h3>
                        <textarea class="job-description" id="jobDescription"
                            placeholder="Enter job description..."></textarea>
                    </div>
                </div>

                <div class="document-meta">
                    <div class="meta-row">
                        <label id="documentNumberLabel">INVOICE NO:</label>
                        <input type="text" id="documentNumber" onchange="updateDocumentNumber()"
                            style="border: none; background: transparent; text-align: right; font-weight: normal;">
                    </div>
                    <div class="meta-row">
                        <label>DATE:</label>
                        <input type="date" id="documentDate" onchange="calculateDueDate()"
                            style="border: none; background: transparent; text-align: right; font-weight: normal;">
                    </div>
                    <div class="meta-row">
                        <label>DUE DATE:</label>
                        <span id="dueDateDisplay">11/8/2025</span>
                    </div>
                </div>
            </div>

            <!-- Line Items Table -->
            <div class="line-items-section">
                <table class="line-items-table">
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Descriptions</th>
                            <th>QTY</th>
                            <th>Rate ($)</th>
                            <th>Line Total ($)</th>
                            <th class="no-print">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lineItemsBody">
                    </tbody>
                </table>

                <div class="add-remove-buttons">
                    <button class="btn btn-primary" onclick="addLineItem()"></button>
                    <button id="undoButton" class="btn btn-secondary" onclick="undoDelete()" style="display: none; margin-left: 10px;"></button>
                </div>
            </div>

            <!-- Payment Terms and Totals -->
            <div class="payment-totals-section">
                <div class="payment-terms">
                    <h4 id="paymentTermsHeader">Payment Terms</h4>
                    <div class="payment-terms-content" id="paymentTermsText">
                        To be paid in full within 5 days following the date of the invoice- thereafter
                        interest on the balance at 2% per month.<br><br>
                        The Account Holder is to be liable for all costs (including solicitor/sent or debt collection
                        costs and expenses) incurred by IRONMARK LIMITED, in the recovery of any sums outstanding and
                        unpaid as a result of the supply of the services and goods (if applicable).
                    </div>
                </div>

                <div class="totals-section">
                    <table class="totals-table">
                        <tr>
                            <td class="label">SUB TOTAL</td>
                            <td class="amount" id="subtotal">$0.00</td>
                        </tr>
                        <tr id="discountRow" style="display: none;" class="hidden-row">
                            <td class="label">DISCOUNT</td>
                            <td class="amount" id="totalDiscount">$0.00</td>
                        </tr>
                        <tr id="taxRow">
                            <td class="label">TAX (<span id="taxRateDisplay">15</span>%)</td>
                            <td class="amount" id="totalTax">$0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td class="label">Total</td>
                            <td class="amount" id="finalTotal">$0.00</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="thank-you">
                <span id="thankYouMessage">Thank you for choosing us!</span>
            </div>
        </div>

        <!-- Right Side: Working Area -->
        <div class="controls-container">
            <!-- Action Buttons -->
            <div class="control-section">
                <button class="btn btn-success" onclick="printDocument()"
                    style="width: 100%; margin-bottom: 10px;"></button>
                <button class="btn btn-primary" onclick="newDocument()" style="width: 100%; margin-bottom: 10px;"></button>
                <div style="background: #dcfce7; border: 1px solid #86efac; padding: 10px; border-radius: 6px; text-align: center; font-size: 12px; color: #166534; margin-bottom: 10px;">
                    <strong> </strong><br>
                    <span style="font-size: 11px;"></span>
                </div>
                <button class="btn btn-secondary" onclick="clearSavedData()" style="width: 100%; font-size: 12px;"></button>
            </div>



            <!-- 1. Document Type Toggle -->
            <div class="control-section">
                <h3></h3>
                <div class="toggle-buttons">
                    <button class="toggle-btn active" onclick="switchDocumentType('invoice')"></button>
                    <button class="toggle-btn" onclick="switchDocumentType('quotation')"></button>
                </div>
            </div>

            <!-- 2. Tax and Discount Management -->
            <div class="control-section">
                <h3></h3>
                <div class="form-group">
                    <label> (%)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="taxRateInput" value="15" min="0" max="100" step="0.01"
                            onchange="updateTaxRate()" style="width: 80px;">
                        <button class="btn btn-secondary" onclick="setTaxRate(0)"></button>
                    </div>
                </div>
                <div class="form-group">
                    <label></label>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 12px; color: #666; margin-bottom: 5px; display: block;"></label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="discountPercent" placeholder="%" min="0" max="100" step="0.01"
                                style="width: 80px;" oninput="handlePercentageDiscountChange()" onchange="handlePercentageDiscountChange()">
                            <span style="font-size: 12px; color: #666; font-style: italic;"></span>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-size: 12px; color: #666; margin-bottom: 5px; display: block;"></label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="discountAmount" placeholder="$" min="0" step="0.01"
                                style="width: 80px;" oninput="handleFixedDiscountChange()" onchange="handleFixedDiscountChange()">
                            <span style="font-size: 12px; color: #666; font-style: italic;"></span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeDiscounts()" style="width: 100%;"></button>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 11px; color: #666;">
                        <strong></strong>
                    </div>
                </div>
            </div>

            <!-- 3. Due Date Settings -->
            <div class="control-section">
                <h3></h3>
                <div class="form-group">
                    <label id="dueDaysLabel"></label>
                    <input type="number" id="dueDays" value="5" min="0" max="365" onchange="updateDueDays()">
                </div>
            </div>

            <!-- 4. Payment Terms -->
            <div class="control-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 id="customMessagesHeader"></h3>
                    <button class="btn btn-secondary" id="editTermsBtn" onclick="toggleTermsEdit()"></button>
                </div>
                <div class="form-group">
                    <label id="termsLabel"></label>
                    <textarea id="customPaymentTerms" rows="4" onchange="updatePaymentTerms()"
                        disabled>To be paid in full within 5 days following the date of the invoice- thereafter interest on the balance at 2% per month. 

The Account Holder is to be liable for all costs (including solicitor/sent or debt collection costs and expenses) incurred by IRONMARK LIMITED, in the recovery of any sums outstanding and unpaid as a result of the supply of the services and goods (if applicable).</textarea>
                </div>
                <div class="form-group">
                    <label></label>
                    <textarea id="customThankYou" rows="2" onchange="updateThankYouMessage()"
                        disabled>Thank you for choosing us!</textarea>
                </div>
            </div>

            <!-- 5. Company Information -->
            <div class="control-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3></h3>
                    <button class="btn btn-secondary" id="editCompanyBtn" onclick="toggleCompanyEdit()"></button>
                </div>
                <div class="form-group">
                    <label></label>
                    <input type="text" id="companyName" value="IRONMARK LIMITED" onchange="updateCompanyInfo()"
                        disabled>
                </div>
                <div class="form-group">
                    <label>GST</label>
                    <input type="text" id="gstNumber" value="124-884-594" onchange="updateCompanyInfo()" disabled>
                </div>
                <div class="form-group">
                    <label></label>
                    <input type="email" id="companyEmail" value="ironmarkinvoice@gmail.com"
                        onchange="updateCompanyInfo()" disabled>
                </div>
                <div class="form-group">
                    <label></label>
                    <input type="text" id="bankDetails" value="(ANZ) 01-0190-0529502-00" onchange="updateCompanyInfo()"
                        disabled>
                </div>
            </div>

            <!-- 6. Logo Upload -->
            <div class="control-section">
                <h3>Logo</h3>
                <div class="form-group">
                    <div style="border: 2px dashed #d1d5db; padding: 20px; text-align: center; border-radius: 6px; cursor: pointer;"
                        onclick="document.getElementById('logoInputControl').click()">
                        <input type="file" id="logoInputControl" accept="image/*" onchange="uploadLogoFromControl(this)"
                            style="display: none;">
                        <img id="logoPreview" style="max-width: 100px; max-height: 100px; display: none;">
                        <div id="logoUploadText">Logo</div>
                    </div>
                    <div id="logoSizeControl" style="display: none; margin-top: 15px;">
                        <label style="font-size: 13px; font-weight: 600; color: #334155; margin-bottom: 8px; display: block;">Logo<span id="logoSizeValue">80</span>px</label>
                        <input type="range" id="logoSizeSlider" min="50" max="200" value="80" 
                            oninput="updateLogoSize(this.value)" 
                            style="width: 100%; height: 6px; border-radius: 5px; background: #e2e8f0; outline: none; appearance: none; -webkit-appearance: none;">
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; margin-top: 5px;">
                            <span>50px</span>
                            <span>200px</span>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeLogo()" style="width: 100%; margin-top: 10px;">Logo</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Global state
        let lineItems = [];
        let taxRate = 15;
        let documentType = 'invoice';
        let nextId = 1;
        let deletedItemsHistory = [];
        let logoSize = 80; // Default logo size in pixels

        // Auto-save functionality
        function saveFormData() {
            const formData = {
                // Document info
                documentType: documentType,
                documentNumber: document.getElementById('documentNumber').value,
                documentDate: document.getElementById('documentDate').value,
                dueDays: document.getElementById('dueDays').value,
                
                // Customer info
                customerInfo: document.getElementById('customerInfo').value,
                jobDescription: document.getElementById('jobDescription').value,
                
                // Line items
                lineItems: lineItems,
                nextId: nextId,
                
                // Tax and discounts
                taxRate: taxRate,
                discountPercent: document.getElementById('discountPercent').value,
                discountAmount: document.getElementById('discountAmount').value,
                
                // Company info
                companyName: document.getElementById('companyName').value,
                gstNumber: document.getElementById('gstNumber').value,
                companyEmail: document.getElementById('companyEmail').value,
                bankDetails: document.getElementById('bankDetails').value,
                
                // Custom messages
                customPaymentTerms: document.getElementById('customPaymentTerms').value,
                customThankYou: document.getElementById('customThankYou').value,
                
                // Logo
                logoSrc: document.getElementById('logoImage').src,
                logoSize: logoSize,
                
                // Timestamp
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('invoiceFormData', JSON.stringify(formData));
        }

        function loadFormData() {
            const savedData = localStorage.getItem('invoiceFormData');
            if (!savedData) return false;
            
            try {
                const formData = JSON.parse(savedData);
                
                // Restore document info
                documentType = formData.documentType || 'invoice';
                document.getElementById('documentNumber').value = formData.documentNumber || '';
                document.getElementById('documentDate').value = formData.documentDate || '';
                document.getElementById('dueDays').value = formData.dueDays || '5';
                
                // Restore customer info
                document.getElementById('customerInfo').value = formData.customerInfo || '';
                document.getElementById('jobDescription').value = formData.jobDescription || '';
                
                // Restore line items
                if (formData.lineItems && formData.lineItems.length > 0) {
                    lineItems = formData.lineItems;
                    nextId = formData.nextId || lineItems.length + 1;
                }
                
                // Restore tax and discounts
                taxRate = formData.taxRate || 15;
                document.getElementById('taxRateInput').value = taxRate;
                document.getElementById('discountPercent').value = formData.discountPercent || '';
                document.getElementById('discountAmount').value = formData.discountAmount || '';
                
                // Restore company info
                document.getElementById('companyName').value = formData.companyName || 'IRONMARK LIMITED';
                document.getElementById('gstNumber').value = formData.gstNumber || '124-884-594';
                document.getElementById('companyEmail').value = formData.companyEmail || 'ironmarkinvoice@gmail.com';
                document.getElementById('bankDetails').value = formData.bankDetails || '(ANZ) 01-0190-0529502-00';
                
                // Restore custom messages
                document.getElementById('customPaymentTerms').value = formData.customPaymentTerms || '';
                document.getElementById('customThankYou').value = formData.customThankYou || 'Thank you for your business!';
                
                // Restore logo
                if (formData.logoSrc && formData.logoSrc !== '' && !formData.logoSrc.includes('about:blank')) {
                    const img = document.getElementById('logoImage');
                    const text = document.getElementById('logoText');
                    const preview = document.getElementById('logoPreview');
                    const uploadText = document.getElementById('logoUploadText');
                    const logoPlaceholder = document.querySelector('.logo-placeholder');
                    
                    img.src = formData.logoSrc;
                    img.classList.add('active');
                    text.style.display = 'none';
                    logoPlaceholder.classList.remove('empty');
                    
                    preview.src = formData.logoSrc;
                    preview.style.display = 'block';
                    uploadText.style.display = 'none';
                    
                    // Restore logo size (simple square approach)
                    if (formData.logoSize) {
                        logoSize = formData.logoSize;
                        logoPlaceholder.style.width = logoSize + 'px';
                        logoPlaceholder.style.height = logoSize + 'px';
                        document.getElementById('logoSizeSlider').value = logoSize;
                        document.getElementById('logoSizeValue').textContent = logoSize;
                        document.getElementById('logoSizeControl').style.display = 'block';
                    }
                }
                
                // Update document type UI
                document.getElementById('documentTitle').textContent = documentType.charAt(0).toUpperCase() + documentType.slice(1);
                document.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase().includes(documentType)) {
                        btn.classList.add('active');
                    }
                });
                
                return true;
            } catch (error) {
                console.error('Error loading saved data:', error);
                return false;
            }
        }

        function clearSavedData() {
            if (confirm('')) {
                localStorage.removeItem('invoiceFormData');
                alert('');
            }
        }

        // Auto-save on any input change
        function setupAutoSave() {
            // Save on input changes
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, textarea')) {
                    saveFormData();
                }
            });
            
            // Save on select changes
            document.addEventListener('change', function(e) {
                if (e.target.matches('input, textarea, select')) {
                    saveFormData();
                }
            });
            
            // Save periodically (every 30 seconds)
            setInterval(saveFormData, 30000);
            
            // Save before page unload
            window.addEventListener('beforeunload', saveFormData);
        }

        // Initialize
        const hasRestoredData = loadFormData();
        
        if (!hasRestoredData) {
            initializeDocument();
            initializeLineItems();
        } else {
            // If data was restored, still update displays and calculations
            updateDisplays();
            renderLineItems();
            updateCalculations();
            updateCompanyInfo();
            updatePaymentTerms();
            updateThankYouMessage();
        }
        
        // Setup auto-save after initialization
        setupAutoSave();

        function initializeDocument() {
            const today = new Date();
            document.getElementById('documentDate').value = today.toISOString().split('T')[0];
            generateInvoiceNumber();
            calculateDueDate();
            updateDisplays();
        }

        function generateInvoiceNumber() {
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            
            // Different prefixes for different document types
            const prefix = documentType === 'invoice' ? 'INV' : 'QUO';
            
            // Get the last used number for today and document type from localStorage
            const storageKey = `${documentType}_counter_${dateStr}`;
            let counter = parseInt(localStorage.getItem(storageKey) || '0');
            
            // Increment counter for new document
            counter++;
            
            // Save the new counter
            localStorage.setItem(storageKey, counter.toString());
            
            // Format: INV-YYYYMMDD-XX or QUO-YYYYMMDD-XX
            const documentNumber = `${prefix}-${dateStr}-${counter.toString().padStart(2, '0')}`;
            
            document.getElementById('documentNumber').value = documentNumber;
            updateDisplays();
        }

        function updateDocumentNumber() {
            updateDisplays();
        }

        function calculateDueDate() {
            const invoiceDate = new Date(document.getElementById('documentDate').value);
            const dueDays = parseInt(document.getElementById('dueDays').value) || 5;
            const dueDate = new Date(invoiceDate.getTime() + (dueDays * 24 * 60 * 60 * 1000));

            updateDisplays();
        }

        function updateDueDays() {
            const dueDays = document.getElementById('dueDays').value;
            calculateDueDate();
            updateDocumentMessage();
        }

        function updateDisplays() {
            // Update due date display
            const invoiceDate = new Date(document.getElementById('documentDate').value);
            const dueDays = parseInt(document.getElementById('dueDays').value) || 5;
            const dueDate = new Date(invoiceDate.getTime() + (dueDays * 24 * 60 * 60 * 1000));
            document.getElementById('dueDateDisplay').textContent = dueDate.toLocaleDateString();
        }

        function initializeLineItems() {
            lineItems = [
                { id: 1, description: '', quantity: 0, rate: 0.00 }
            ];
            nextId = 2;
            renderLineItems();
            updateCalculations();
        }

        // Document Type Management
        function switchDocumentType(type) {
            documentType = type;
            document.getElementById('documentTitle').textContent = type.charAt(0).toUpperCase() + type.slice(1);

            const label = type === 'invoice' ? 'INVOICE' : 'QUOTATION';
            document.getElementById('invoiceToLabel').textContent = `${label} TO:`;
            document.getElementById('documentNumberLabel').textContent = `${label} NO:`;

            // Update job label
            const jobLabel = document.getElementById('jobLabel');
            if (type === 'quotation') {
                jobLabel.textContent = 'QUOTATION JOB:';
            } else {
                jobLabel.textContent = 'PAINTING JOB:';
            }

            // Update due date settings based on document type
            const dueDaysInput = document.getElementById('dueDays');
            if (type === 'invoice') {
                dueDaysInput.value = 5; // Invoice: 5 days payment terms
            } else {
                dueDaysInput.value = 30; // Quotation: 30 days validity
            }

            // Update headers and labels in controls
            const customMessagesHeader = document.getElementById('customMessagesHeader');
            const termsLabel = document.getElementById('termsLabel');
            const paymentTermsHeader = document.getElementById('paymentTermsHeader');

            const isInvoice = type === 'invoice';
            if (customMessagesHeader) customMessagesHeader.textContent = isInvoice ? '' : '';
            if (termsLabel) termsLabel.textContent = isInvoice ? '' : '';
            if (paymentTermsHeader) paymentTermsHeader.textContent = isInvoice ? 'Payment Terms' : 'Quotation Terms';

            // Update due date label text
            const dueDaysLabel = document.getElementById('dueDaysLabel');
            if (dueDaysLabel) {
                if (isInvoice) {
                    dueDaysLabel.textContent = '';
                } else {
                    dueDaysLabel.textContent = '';
                }
            }

            // Generate new document number for the selected type
            generateInvoiceNumber();

            // Update toggle button states
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            updateDocumentMessage();
            calculateDueDate();
            updateDisplays();
        }

        function updateDocumentMessage() {
            const dueDays = document.getElementById('dueDays').value;
            const isInvoice = documentType === 'invoice';

            let message;
            if (isInvoice) {
                message = `To be paid in full within ${dueDays} days following the date of the invoice- thereafter interest on the balance at 2% per month.<br><br>The Account Holder is to be liable for all costs (including solicitor/sent or debt collection costs and expenses) incurred by IRONMARK LIMITED, in the recovery of any sums outstanding and unpaid as a result of the supply of the services and goods (if applicable).`;
            } else {
                message = `This quotation is valid for ${dueDays} days from the date of issue. All prices are inclusive of materials and labor. A 50% deposit is required before commencement of work.<br><br>Final payment is due upon completion of the project. Any additional work outside the scope of this quotation will be charged separately and requires written approval.`;
            }

            document.getElementById('paymentTermsText').innerHTML = message;

            // Update the custom textarea
            const customPaymentTerms = document.getElementById('customPaymentTerms');
            if (customPaymentTerms) {
                customPaymentTerms.value = message.replace(/<br><br>/g, '\n\n');
            }
        }

        // Company Info Management
        function updateCompanyInfo() {
            document.getElementById('displayCompanyName').textContent = document.getElementById('companyName').value;
            document.getElementById('displayGstNumber').textContent = document.getElementById('gstNumber').value;
            document.getElementById('displayCompanyEmail').textContent = document.getElementById('companyEmail').value;
            document.getElementById('displayBankDetails').textContent = document.getElementById('bankDetails').value;
        }

        // Logo Management - Redesigned for reliability
        function uploadLogoFromControl(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('logoImage');
                    const text = document.getElementById('logoText');
                    const logoPlaceholder = document.querySelector('.logo-placeholder');
                    
                    // Set image source and show it
                    img.src = e.target.result;
                    img.classList.add('active');
                    text.style.display = 'none';
                    logoPlaceholder.classList.remove('empty');
                    
                    // Apply current logo size (simple square approach)
                    logoPlaceholder.style.width = logoSize + 'px';
                    logoPlaceholder.style.height = logoSize + 'px';

                    // Update preview in control panel
                    const preview = document.getElementById('logoPreview');
                    const uploadText = document.getElementById('logoUploadText');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    uploadText.style.display = 'none';
                    
                    // Show logo size control
                    document.getElementById('logoSizeControl').style.display = 'block';
                    
                    saveFormData();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateLogoSize(size) {
            logoSize = parseInt(size);
            const logoPlaceholder = document.querySelector('.logo-placeholder');
            const logoSizeValue = document.getElementById('logoSizeValue');
            
            // Simple approach: make it a square that scales uniformly
            logoPlaceholder.style.width = logoSize + 'px';
            logoPlaceholder.style.height = logoSize + 'px';
            
            // Update display value
            logoSizeValue.textContent = logoSize;
            
            saveFormData();
        }

        function removeLogo() {
            const img = document.getElementById('logoImage');
            const text = document.getElementById('logoText');
            const logoPlaceholder = document.querySelector('.logo-placeholder');
            
            // Hide image and show placeholder text
            img.classList.remove('active');
            img.src = '';
            text.style.display = 'block';
            logoPlaceholder.classList.add('empty');
            
            // Reset to default size
            logoSize = 80;
            logoPlaceholder.style.width = '80px';
            logoPlaceholder.style.height = '80px';

            // Remove preview in control panel
            const preview = document.getElementById('logoPreview');
            const uploadText = document.getElementById('logoUploadText');
            const input = document.getElementById('logoInputControl');
            preview.style.display = 'none';
            uploadText.style.display = 'block';
            preview.src = '';
            input.value = '';
            
            // Hide and reset logo size control
            document.getElementById('logoSizeControl').style.display = 'none';
            document.getElementById('logoSizeSlider').value = 80;
            document.getElementById('logoSizeValue').textContent = '80';
            
            saveFormData();
        }

        // Line Items Management
        function addLineItem() {
            const lineItem = {
                id: nextId++,
                description: '',
                quantity: 0,
                rate: 0.00
            };
            lineItems.push(lineItem);
            
            // Recalculate percentage discounts when new items are added
            recalculatePercentageDiscounts();
            
            renderLineItems();
            updateCalculations();
            saveFormData();
        }



        function removeLineItem(id) {
            const itemToDelete = lineItems.find(item => item.id === id);
            if (itemToDelete) {
                // Store deleted item with timestamp for history
                deletedItemsHistory.push({
                    item: { ...itemToDelete },
                    timestamp: Date.now()
                });
                
                // Keep only last 10 deletions to prevent memory issues
                if (deletedItemsHistory.length > 10) {
                    deletedItemsHistory.shift();
                }
                
                // Remove the item
                lineItems = lineItems.filter(item => item.id !== id);
                
                // Remove any discounts linked to this row
                removeLinkedDiscounts(id);
                
                // Recalculate percentage discounts if any exist
                recalculatePercentageDiscounts();
                
                renderLineItems();
                updateCalculations();
                updateUndoButton();
                saveFormData();
            }
        }

        function recalculatePercentageDiscounts() {
            // Check if there's a percentage discount in the input field
            const currentPercent = parseFloat(document.getElementById('discountPercent').value);
            
            if (currentPercent > 0 && currentPercent <= 100) {
                // Remove existing percentage discounts
                lineItems = lineItems.filter(item => item.discountType !== 'percentage');
                
                // Add updated percentage discount
                const subtotal = calculatePositiveSubtotal();
                const discountAmount = subtotal * (currentPercent / 100);
                
                if (discountAmount > 0) {
                    addDiscountLineItem(`Discount (${currentPercent}%)`, -discountAmount, 'percentage');
                }
            }
        }

        function undoDelete() {
            if (deletedItemsHistory.length > 0) {
                const lastDeleted = deletedItemsHistory.pop();
                lineItems.push(lastDeleted.item);
                renderLineItems();
                updateCalculations();
                updateUndoButton();
                saveFormData();
            }
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undoButton');
            if (undoBtn) {
                if (deletedItemsHistory.length > 0) {
                    undoBtn.style.display = 'inline-block';
                    undoBtn.textContent = ` (${deletedItemsHistory.length})`;
                } else {
                    undoBtn.style.display = 'none';
                }
            }
        }

        function clearUndoHistory() {
            deletedItemsHistory = [];
            updateUndoButton();
        }

        // Rate editing functions
        function editRate(cell, itemId, isDiscount) {
            cell.classList.add('editing');
            const input = cell.querySelector('.rate-input');
            input.focus();
            input.select();
        }

        function updateRateFromInput(input, itemId, isDiscount) {
            const value = parseFloat(input.value) || 0;
            const finalValue = isDiscount ? -value : value;
            updateLineItem(itemId, 'rate', finalValue);
        }

        function finishRateEdit(input) {
            const cell = input.parentElement;
            cell.classList.remove('editing');
        }

        function updateLineItem(id, field, value) {
            const item = lineItems.find(item => item.id === id);
            if (item) {
                if (field === 'quantity' || field === 'rate') {
                    const numValue = parseFloat(value) || 0;
                    item[field] = numValue;
                    
                    // Always recalculate percentage discounts when any regular item changes
                    // This ensures discounts stay current with the subtotal
                    recalculatePercentageDiscounts();
                } else {
                    item[field] = value;
                }
                renderLineItems();
                updateCalculations();
            }
        }

        function renderLineItems() {
            const tbody = document.getElementById('lineItemsBody');
            tbody.innerHTML = '';

            // Separate regular items and discount items
            const regularItems = lineItems.filter(item => (item.quantity * item.rate) >= 0);
            const discountItems = lineItems.filter(item => (item.quantity * item.rate) < 0);
            
            // Combine them with discounts at the end
            const sortedItems = [...regularItems, ...discountItems];

            sortedItems.forEach((item, index) => {
                const total = item.quantity * item.rate;
                const row = document.createElement('tr');

                const isDiscount = total < 0;
                const rowStyle = isDiscount ? 'style="background-color: #fef3c7;"' : '';

                row.innerHTML = `
                    <td ${rowStyle}>${index + 1}</td>
                    <td ${rowStyle}><input type="text" value="${item.description}" onchange="updateLineItem(${item.id}, 'description', this.value)" ${isDiscount ? 'style="background-color: #fef3c7;"' : ''}></td>
                    <td ${rowStyle}><input type="number" value="${item.quantity}" step="0.01" onchange="updateLineItem(${item.id}, 'quantity', this.value)" ${isDiscount ? 'style="background-color: #fef3c7;"' : ''}></td>
                    <td ${rowStyle} onclick="editRate(this, ${item.id}, ${isDiscount})">
                        <span class="rate-display">${isDiscount ? '-$' : '$'}${formatCurrency(Math.abs(item.rate))}</span>
                        <input type="number" value="${Math.abs(item.rate)}" step="0.01" onchange="updateRateFromInput(this, ${item.id}, ${isDiscount})" onblur="finishRateEdit(this)" class="rate-input" ${isDiscount ? 'style="background-color: #fef3c7;"' : ''}>
                    </td>
                    <td ${rowStyle}>${total < 0 ? '-$' : '$'}${formatCurrency(Math.abs(total))}</td>
                    <td class="no-print"><button class="btn btn-danger action-btn" onclick="removeLineItem(${item.id})"></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Tax Management
        function updateTaxRate() {
            taxRate = parseFloat(document.getElementById('taxRateInput').value) || 0;

            // Update tax rate display in totals
            const taxRateDisplay = document.getElementById('taxRateDisplay');
            if (taxRateDisplay) {
                taxRateDisplay.textContent = taxRate;
            }

            updateCalculations();
        }

        function setTaxRate(rate) {
            taxRate = rate;
            document.getElementById('taxRateInput').value = rate;

            // Update tax rate display in totals
            const taxRateDisplay = document.getElementById('taxRateDisplay');
            if (taxRateDisplay) {
                taxRateDisplay.textContent = rate;
            }

            updateCalculations();
        }

        // Real-time Discount Management
        function handlePercentageDiscountChange() {
            const percent = parseFloat(document.getElementById('discountPercent').value);
            
            // Remove existing percentage discounts first
            lineItems = lineItems.filter(item => 
                !(item.discountType === 'percentage')
            );
            
            if (percent > 0 && percent <= 100) {
                const subtotal = calculatePositiveSubtotal();
                const discountAmount = subtotal * (percent / 100);
                
                if (discountAmount > 0) {
                    addDiscountLineItem(`Discount (${percent}%)`, -discountAmount, 'percentage');
                }
            }
            
            renderLineItems();
            updateCalculations();
        }

        function handleFixedDiscountChange() {
            const amount = parseFloat(document.getElementById('discountAmount').value);
            
            // Remove existing fixed discounts first
            lineItems = lineItems.filter(item => 
                !(item.discountType === 'fixed')
            );
            
            if (amount > 0) {
                addDiscountLineItem('Fixed Discount', -amount, 'fixed');
                renderLineItems();
                updateCalculations();
            }
        }



        function addDiscountLineItem(description, amount, type = 'fixed', linkedRowId = null) {
            const lineItem = {
                id: nextId++,
                description: description,
                quantity: 1,
                rate: amount,
                discountType: type,
                linkedRowId: linkedRowId
            };
            lineItems.push(lineItem);
            // Don't auto-render here, let calling function handle it
        }

        function removeDiscounts() {
            lineItems = lineItems.filter(item => !item.discountType);
            
            // Clear discount input fields
            document.getElementById('discountPercent').value = '';
            document.getElementById('discountAmount').value = '';
            
            renderLineItems();
            updateCalculations();
        }

        function removeLinkedDiscounts(deletedRowId) {
            // Remove any discounts linked to the deleted row
            lineItems = lineItems.filter(item => item.linkedRowId !== deletedRowId);
        }

        function calculatePositiveSubtotal() {
            return lineItems.reduce((sum, item) => {
                // Only include items that are not discounts (positive amounts)
                const itemTotal = item.quantity * item.rate;
                if (itemTotal > 0 && !item.discountType) {
                    return sum + itemTotal;
                }
                return sum;
            }, 0);
        }

        // Calculations

        function calculateDiscountAmount() {
            return lineItems.reduce((sum, item) => {
                const itemTotal = item.quantity * item.rate;
                return itemTotal < 0 ? sum + Math.abs(itemTotal) : sum;
            }, 0);
        }

        function calculateTax(subtotal) {
            // Tax should be calculated on the subtotal after discounts are applied
            const taxableAmount = subtotal; // This is already the net amount after discounts
            return taxableAmount * (taxRate / 100);
        }

        function updateCalculations() {
            const grossSubtotal = calculatePositiveSubtotal(); // Only positive items
            const discountAmount = calculateDiscountAmount(); // Total discount amount
            const netSubtotal = grossSubtotal - discountAmount; // Subtotal after discounts
            const tax = calculateTax(netSubtotal); // Tax on discounted amount
            const total = netSubtotal + tax;

            // Update values - show gross subtotal in the subtotal line
            document.getElementById('subtotal').textContent = '$' + formatCurrency(grossSubtotal);
            document.getElementById('totalTax').textContent = '$' + formatCurrency(tax);
            document.getElementById('finalTotal').textContent = '$' + formatCurrency(total);

            // Dynamic discount row visibility
            const discountRow = document.getElementById('discountRow');
            const discountDisplay = document.getElementById('totalDiscount');
            if (discountAmount > 0) {
                discountRow.style.display = 'table-row';
                discountRow.classList.remove('hidden-row');
                discountDisplay.textContent = '$' + formatCurrency(discountAmount);
            } else {
                discountRow.style.display = 'none';
                discountRow.classList.add('hidden-row');
            }
        }

        // Custom Messages
        function updatePaymentTerms() {
            const paymentTermsText = document.getElementById('paymentTermsText');
            const customPaymentTerms = document.getElementById('customPaymentTerms');
            if (paymentTermsText && customPaymentTerms) {
                paymentTermsText.innerHTML = customPaymentTerms.value.replace(/\n/g, '<br>');
            }
        }

        function updateThankYouMessage() {
            const thankYouMessage = document.getElementById('thankYouMessage');
            const customThankYou = document.getElementById('customThankYou');
            if (thankYouMessage && customThankYou) {
                thankYouMessage.textContent = customThankYou.value;
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return Math.abs(amount).toFixed(2);
        }

        function newDocument() {
            if (confirm('')) {
                lineItems = [];
                nextId = 1;
                taxRate = 15;
                clearUndoHistory();

                document.getElementById('customerInfo').value = '';
                document.getElementById('jobDescription').value = '';
                document.getElementById('discountPercent').value = '';
                document.getElementById('discountAmount').value = '';
                document.getElementById('taxRateInput').value = '15';
                document.getElementById('dueDays').value = '5';

                generateInvoiceNumber();
                document.getElementById('documentDate').value = new Date().toISOString().split('T')[0];
                calculateDueDate();

                initializeLineItems();
                
                // Clear saved data
                localStorage.removeItem('invoiceFormData');
                saveFormData();
            }
        }

        function printDocument() {
            // Get the current document number for the filename
            const documentNumber = document.getElementById('documentNumber').value;
            const originalTitle = document.title;
            
            // Set the document title to the invoice/quotation number for PDF filename
            if (documentNumber) {
                document.title = documentNumber;
            }
            
            // Print the document
            window.print();
            
            // Restore the original title after a short delay
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }

        // Edit/Save functionality
        function toggleTermsEdit() {
            const textarea1 = document.getElementById('customPaymentTerms');
            const textarea2 = document.getElementById('customThankYou');
            const btn = document.getElementById('editTermsBtn');

            if (textarea1.disabled) {
                textarea1.disabled = false;
                textarea2.disabled = false;
                btn.textContent = '';
                btn.className = 'btn btn-success';
            } else {
                textarea1.disabled = true;
                textarea2.disabled = true;
                btn.textContent = '';
                btn.className = 'btn btn-secondary';
                updatePaymentTerms();
                updateThankYouMessage();
            }
        }

        function toggleCompanyEdit() {
            const inputs = ['companyName', 'gstNumber', 'companyEmail', 'bankDetails'];
            const btn = document.getElementById('editCompanyBtn');
            const firstInput = document.getElementById(inputs[0]);

            if (firstInput.disabled) {
                inputs.forEach(id => document.getElementById(id).disabled = false);
                btn.textContent = '';
                btn.className = 'btn btn-success';
            } else {
                inputs.forEach(id => document.getElementById(id).disabled = true);
                btn.textContent = '';
                btn.className = 'btn btn-secondary';
                updateCompanyInfo();
            }
        }
    </script>
</body>

</html>